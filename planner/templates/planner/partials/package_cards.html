{% load planner_extras %}

{% if plan.status != "completed" and not package_count %}
  <div class="space-y-4">
    {% for _ in "1234"|make_list %}
      <article class="tp-card tp-skeleton animate-pulse rounded-2xl border border-ink/10 bg-white p-5 shadow-sm">
        <div class="h-4 w-1/3 rounded bg-sky/40"></div>
        <div class="mt-3 h-8 w-1/2 rounded bg-sky/25"></div>
        <div class="mt-4 grid gap-3 md:grid-cols-3">
          <div class="h-20 rounded-xl bg-sky/20"></div>
          <div class="h-20 rounded-xl bg-sky/20"></div>
          <div class="h-20 rounded-xl bg-sky/20"></div>
        </div>
      </article>
    {% endfor %}
  </div>

{% elif not packages %}
  <div class="tp-card rounded-2xl border border-ink/10 bg-white p-6 shadow-sm">
    <p class="text-sm font-semibold text-ink">No package cards available</p>
    <p class="mt-2 text-sm text-ink/70">
      {% if plan.status == "completed" %}
        The plan completed, but no package rows were persisted for rendering.
      {% elif plan.status == "failed" %}
        The plan failed before package assembly completed.
      {% else %}
        Package assembly is still running.
      {% endif %}
    </p>
    <ul class="mt-3 space-y-1 text-xs text-ink/70">
      <li>Check provider health and recent partial-failure messages.</li>
      <li>Try a different destination or date window.</li>
      <li>Flight and hotel links remain links-only (no checkout on TriPPlanner).</li>
    </ul>
  </div>

{% else %}
  <div class="space-y-4">
    {% for package in packages %}
      {% with comp=package.component_summary breakdown=package.price_breakdown %}
      <article class="tp-package-card rounded-2xl border border-ink/10 bg-white p-5 shadow-sm transition hover:-translate-y-0.5 hover:shadow-md">
        <div class="flex flex-wrap items-start justify-between gap-4">
          <div>
            <p class="tp-badge text-xs font-semibold uppercase tracking-wider text-ink/50">
              {{ package.candidate.airport_code }} · {{ package.candidate.city_name }}, {{ package.candidate.country_code }}
            </p>
            <div class="mt-1 flex flex-wrap items-end gap-3">
              <h3 class="text-2xl font-extrabold">{{ package.total_price|money:package.currency }}</h3>
              <span class="rounded-full bg-sky/40 px-2 py-1 text-xs font-semibold text-ink">Rank #{{ package.rank }}</span>
              <span class="rounded-full bg-mint/20 px-2 py-1 text-xs font-semibold text-ink">Score {{ package.score }}</span>
            </div>
            <p class="mt-1 text-xs text-ink/60">
              Flight {{ breakdown.flight_total|default:package.flight_option.total_price|money:package.currency }}
              + Hotel {{ breakdown.hotel_total|default:package.hotel_option.total_price|money:package.currency }}
              = Total {{ breakdown.package_total|default:package.total_price|money:package.currency }}
            </p>
            {% with tours_optional=breakdown.optional_tours_total|default:"0.00" %}
              {% if tours_optional != "0.00" and tours_optional != "0" %}
                <p class="mt-1 text-[11px] text-ink/60">Optional tours shown below: {{ tours_optional|money:package.currency }} (not included in total).</p>
              {% endif %}
            {% endwith %}
          </div>
        </div>

        <div class="mt-4 grid gap-3 lg:grid-cols-[1.3fr_1fr]">
          <div class="space-y-3">
            <div class="grid gap-3 md:grid-cols-3">
              <section class="rounded-xl border border-ink/10 bg-sky/10 p-3">
                <p class="text-xs font-semibold uppercase tracking-wide text-ink/60">Flight</p>
                <p class="mt-1 text-sm font-semibold">{{ comp.flight.title|default:package.flight_option.origin_airport }}{% if comp.flight.title %}{% else %} to {{ package.flight_option.destination_airport }}{% endif %}</p>
                <p class="text-xs text-ink/60">
                  {{ package.flight_option.duration_minutes|duration_hm }} · {{ package.flight_option.stops }} stop{{ package.flight_option.stops|pluralize }}
                </p>
                <p class="mt-1 text-xs">
                  <span class="rounded-full {% if comp.flight.fallback_search|default:False or comp.flight.link_type|default:package.flight_option.link_type != 'item' %}bg-amber-100 text-amber-800{% else %}bg-emerald-100 text-emerald-700{% endif %} px-2 py-0.5 font-semibold">
                    {% if comp.flight.fallback_search|default:False or comp.flight.link_type|default:package.flight_option.link_type != "item" %}
                      Search results link
                    {% else %}
                      Specific item link
                    {% endif %}
                  </span>
                </p>
              </section>

              <section class="rounded-xl border border-ink/10 bg-sky/10 p-3">
                <p class="text-xs font-semibold uppercase tracking-wide text-ink/60">Hotel</p>
                <p class="mt-1 text-sm font-semibold">{{ comp.hotel.title|default:package.hotel_option.name }}</p>
                <p class="text-xs text-ink/60">
                  {{ package.hotel_option.star_rating|default:0 }}★ · Guest {{ package.hotel_option.guest_rating|default:0 }} · {{ package.hotel_option.neighborhood|default:"Area TBD" }}
                </p>
                <p class="mt-1 text-xs">
                  <span class="rounded-full {% if comp.hotel.fallback_search|default:False or comp.hotel.link_type|default:package.hotel_option.link_type != 'item' %}bg-amber-100 text-amber-800{% else %}bg-emerald-100 text-emerald-700{% endif %} px-2 py-0.5 font-semibold">
                    {% if comp.hotel.fallback_search|default:False or comp.hotel.link_type|default:package.hotel_option.link_type != "item" %}
                      Search results link
                    {% else %}
                      Specific item link
                    {% endif %}
                  </span>
                </p>
              </section>

              <section class="rounded-xl border border-ink/10 bg-sky/10 p-3">
                <p class="text-xs font-semibold uppercase tracking-wide text-ink/60">Signals</p>
                <p class="mt-1 text-xs text-ink/70">Freshness {{ package.freshness_at|minutes_ago }}</p>
                <p class="text-xs text-ink/70">Confidence {{ package.data_confidence|floatformat:2 }}</p>
                <p class="text-xs text-ink/70">Family score {{ comp.signals.family_friendly_score|default:0 }}</p>
              </section>
            </div>

            <div class="package-action-grid grid gap-2 sm:grid-cols-2 lg:grid-cols-4">
              {% with flight_href=comp.flight.outbound_url|default:package.flight_url|default:package.flight_option.deeplink_url %}
              <a
                href="{{ flight_href }}"
                target="_blank"
                rel="noopener"
                class="tp-button track-click inline-flex items-center justify-center rounded-lg border border-ink/15 bg-white px-3 py-2 text-xs font-semibold hover:bg-sky/30"
                data-provider="{{ comp.flight.provider|default:package.flight_option.provider }}"
                data-link-type="flight"
                data-destination="{{ package.candidate.city_name }}-{{ package.candidate.country_code }}"
                data-correlation-id="{{ package.plan_id }}:{{ package.id }}:flight:selected"
                data-plan-id="{{ package.plan_id }}"
                data-package-id="{{ package.id }}"
              >View Flight</a>
              {% endwith %}

              {% with hotel_href=comp.hotel.outbound_url|default:package.hotel_url|default:package.hotel_option.deeplink_url %}
              <a
                href="{{ hotel_href }}"
                target="_blank"
                rel="noopener"
                class="tp-button track-click inline-flex items-center justify-center rounded-lg border border-ink/15 bg-white px-3 py-2 text-xs font-semibold hover:bg-sky/30"
                data-provider="{{ comp.hotel.provider|default:package.hotel_option.provider }}"
                data-link-type="hotel"
                data-destination="{{ package.candidate.city_name }}-{{ package.candidate.country_code }}"
                data-correlation-id="{{ package.plan_id }}:{{ package.id }}:hotel:selected"
                data-plan-id="{{ package.plan_id }}"
                data-package-id="{{ package.id }}"
              >View Hotel</a>
              {% endwith %}

              {% with tour_href=package.tours_url %}
              {% if comp.tours and comp.tours.0.outbound_url %}
                {% with tour_href=comp.tours.0.outbound_url %}
                  <a
                    href="{{ tour_href }}"
                    target="_blank"
                    rel="noopener"
                    class="tp-button track-click inline-flex items-center justify-center rounded-lg border border-ink/15 bg-white px-3 py-2 text-xs font-semibold hover:bg-sky/30"
                    data-provider="{{ comp.tours.0.provider|default:'travelpayouts' }}"
                    data-link-type="tour"
                    data-destination="{{ package.candidate.city_name }}-{{ package.candidate.country_code }}"
                    data-correlation-id="{{ package.plan_id }}:{{ package.id }}:tour:selected"
                    data-plan-id="{{ package.plan_id }}"
                    data-package-id="{{ package.id }}"
                  >View Tours</a>
                {% endwith %}
              {% elif tour_href %}
                <a
                  href="{{ tour_href }}"
                  target="_blank"
                  rel="noopener"
                  class="tp-button track-click inline-flex items-center justify-center rounded-lg border border-ink/15 bg-white px-3 py-2 text-xs font-semibold hover:bg-sky/30"
                  data-provider="travelpayouts"
                  data-link-type="tour"
                  data-destination="{{ package.candidate.city_name }}-{{ package.candidate.country_code }}"
                  data-correlation-id="{{ package.plan_id }}:{{ package.id }}:tour:fallback"
                  data-plan-id="{{ package.plan_id }}"
                  data-package-id="{{ package.id }}"
                >View Tours</a>
              {% else %}
                <span class="inline-flex items-center justify-center rounded-lg border border-ink/10 bg-white/60 px-3 py-2 text-xs font-semibold text-ink/50">Tours unavailable</span>
              {% endif %}
              {% endwith %}

              <a
                href="{% url 'planner:package-detail-public' plan.public_token package.id %}"
                class="inline-flex items-center justify-center rounded-lg bg-ink px-3 py-2 text-xs font-semibold text-white hover:bg-ocean"
              >View Details</a>
            </div>

            <div class="rounded-xl border border-ink/10 bg-white/80 p-3">
              <p class="text-xs font-semibold uppercase tracking-wide text-ink/60">Why Ranked</p>
              <ul class="mt-2 space-y-1 text-xs text-ink/70">
                {% for note in package.score_breakdown.why_ranked|default:package.explanations|slice:":5" %}
                  <li>• {{ note }}</li>
                {% endfor %}
              </ul>
            </div>
          </div>

          <div class="space-y-3">
            <section class="rounded-xl border border-ink/10 bg-white/80 p-3">
              <div class="flex items-center justify-between">
                <p class="text-xs font-semibold uppercase tracking-wide text-ink/60">Breakdown</p>
                <span class="text-xs font-semibold text-ink/60">{{ package.currency }}</span>
              </div>
              <div class="mt-2 space-y-1 text-xs">
                <div class="flex items-center justify-between"><span>Flight total</span><span>{{ breakdown.flight_total|default:package.flight_option.total_price|money:package.currency }}</span></div>
                <div class="flex items-center justify-between"><span>Hotel total</span><span>{{ breakdown.hotel_total|default:package.hotel_option.total_price|money:package.currency }}</span></div>
                {% with tours_optional=breakdown.optional_tours_total|default:"0.00" %}
                  <div class="flex items-center justify-between {% if tours_optional == '0.00' or tours_optional == '0' %}opacity-40{% endif %}">
                    <span>Optional tours (excluded)</span>
                    <span>{{ tours_optional|money:package.currency }}</span>
                  </div>
                {% endwith %}
                <div class="flex items-center justify-between text-ink/60"><span>Fees / variance</span><span>{{ breakdown.fees_variance|default:"0.00"|money:package.currency }}</span></div>
                <div class="mt-2 border-t border-ink/10 pt-2 flex items-center justify-between text-sm font-bold"><span>Package total</span><span>{{ breakdown.package_total|default:package.total_price|money:package.currency }}</span></div>
              </div>
            </section>

            <section class="rounded-xl border border-ink/10 bg-white/80 p-3">
              <p class="text-xs font-semibold uppercase tracking-wide text-ink/60">Optional Add-ons</p>
              <div class="mt-2 space-y-2">
                {% for tour in comp.tours|default:package.tour_entities|slice:":3" %}
                  <div class="rounded-lg border border-ink/10 bg-sky/10 px-2 py-2">
                    <div class="flex items-start justify-between gap-2">
                      <div>
                        <p class="text-xs font-semibold text-ink">{{ tour.title|default:tour.name }}</p>
                        <p class="text-[11px] text-ink/60">
                          {% if tour.fallback_search|default:False or tour.link_type|default:"search" != "item" %}Search results link{% else %}Specific item link{% endif %}
                          {% if tour.price and tour.price != "0.00" and tour.price != "0" %}
                            - {{ tour.currency|default:package.currency }} {{ tour.price }}{% if tour.is_estimated %} (estimated){% endif %}
                          {% endif %}
                        </p>
                      </div>
                      {% if tour.outbound_url or tour.link %}
                        <a
                          href="{{ tour.outbound_url|default:tour.link }}"
                          target="_blank"
                          rel="noopener"
                          class="tp-button track-click text-[11px] font-semibold text-ocean"
                          data-provider="{{ tour.provider|default:'travelpayouts' }}"
                          data-link-type="tour"
                          data-destination="{{ package.candidate.city_name }}-{{ package.candidate.country_code }}"
                          data-correlation-id="{{ package.plan_id }}:{{ package.id }}:tour:{{ forloop.counter }}"
                          data-plan-id="{{ package.plan_id }}"
                          data-package-id="{{ package.id }}"
                        >Open</a>
                      {% endif %}
                    </div>
                    {% if tour.rationale %}
                      <p class="mt-1 text-[11px] text-ink/60">{{ tour.rationale }}</p>
                    {% endif %}
                  </div>
                {% empty %}
                  <p class="text-xs text-ink/60">No tour options attached; fallback search link will be shown.</p>
                {% endfor %}
              </div>
            </section>

            {% if package.place_entities %}
            <section class="rounded-xl border border-ink/10 bg-white/80 p-3">
              <p class="text-xs font-semibold uppercase tracking-wide text-ink/60">Must-see Places</p>
              <div class="mt-2 grid gap-2 sm:grid-cols-2">
                {% for item in package.place_entities|slice:":4" %}
                  <div class="rounded-lg border border-ink/10 bg-sky/10 px-2 py-2">
                    <p class="truncate text-xs font-semibold text-ink">{{ item.title|default:item.name }}</p>
                    <div class="mt-2 flex items-center gap-2">
                      <a
                        href="{{ item.outbound_url|default:item.link }}"
                        target="_blank"
                        rel="noopener"
                        class="tp-button track-click inline-flex items-center rounded-lg border border-ink/10 bg-white px-2 py-1 text-[11px] font-semibold text-ink"
                        data-provider="{{ item.provider|default:'places' }}"
                        data-link-type="place"
                        data-destination="{{ package.candidate.city_name }}-{{ package.candidate.country_code }}"
                        data-correlation-id="{{ package.plan_id }}:{{ package.id }}:place:{{ forloop.counter }}"
                        data-plan-id="{{ package.plan_id }}"
                        data-package-id="{{ package.id }}"
                      >Open</a>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </section>
            {% endif %}
          </div>
        </div>

        <div class="mt-4 flex items-center justify-between gap-2">
          <div class="text-xs text-ink/60">Links-only planner · No checkout on TriPPlanner · Scored {{ package.last_scored_at|minutes_ago }}</div>
        </div>
      </article>
      {% endwith %}
    {% endfor %}
  </div>
{% endif %}
