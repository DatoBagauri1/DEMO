{% extends "base.html" %}

{% block title %}Profile | TriPPlanner{% endblock %}

{% block content %}
<div class="profile-page space-y-6">
  <section class="rounded-3xl border border-ink/10 bg-white p-6 shadow-sm">
    <div class="flex items-center justify-between gap-3">
      <div>
        <h1 class="text-2xl font-extrabold">Profile</h1>
        <p class="mt-1 text-sm text-ink/70">Personal information and your places wishlist.</p>
      </div>
      <span class="rounded-full bg-sky/40 px-3 py-1 text-xs font-semibold text-ink">
        {{ saved_places_count }} saved place{{ saved_places_count|pluralize }}
      </span>
    </div>

    <form method="post" class="mt-5 space-y-4">
      {% csrf_token %}
      <div class="grid gap-3 sm:grid-cols-2">
        <div class="rounded-xl border border-ink/10 bg-sky/10 p-3">
          <p class="text-xs font-semibold uppercase tracking-wide text-ink/60">Username</p>
          <p class="mt-1 text-sm font-semibold text-ink">{{ request.user.username }}</p>
        </div>

        <div class="rounded-xl border border-ink/10 bg-white p-3">
          <p class="text-xs font-semibold uppercase tracking-wide text-ink/60">Email</p>
          {{ personal_info_form.email }}
          {% if personal_info_form.email.errors %}
            <p class="mt-1 text-xs text-rose-600">{{ personal_info_form.email.errors|striptags }}</p>
          {% endif %}
        </div>

        <div class="rounded-xl border border-ink/10 bg-white p-3">
          <p class="text-xs font-semibold uppercase tracking-wide text-ink/60">First Name</p>
          {{ personal_info_form.first_name }}
          {% if personal_info_form.first_name.errors %}
            <p class="mt-1 text-xs text-rose-600">{{ personal_info_form.first_name.errors|striptags }}</p>
          {% endif %}
        </div>

        <div class="rounded-xl border border-ink/10 bg-white p-3">
          <p class="text-xs font-semibold uppercase tracking-wide text-ink/60">Last Name</p>
          {{ personal_info_form.last_name }}
          {% if personal_info_form.last_name.errors %}
            <p class="mt-1 text-xs text-rose-600">{{ personal_info_form.last_name.errors|striptags }}</p>
          {% endif %}
        </div>

        <div class="rounded-xl border border-ink/10 bg-white p-3">
          <p class="text-xs font-semibold uppercase tracking-wide text-ink/60">Date Joined</p>
          <p class="mt-1 text-sm font-semibold text-ink">{{ request.user.date_joined|date:"Y-m-d H:i" }}</p>
        </div>

        <div class="rounded-xl border border-ink/10 bg-white p-3">
          <p class="text-xs font-semibold uppercase tracking-wide text-ink/60">Last Login</p>
          <p class="mt-1 text-sm font-semibold text-ink">
            {% if request.user.last_login %}{{ request.user.last_login|date:"Y-m-d H:i" }}{% else %}&mdash;{% endif %}
          </p>
        </div>
      </div>

      <div class="profile-form-actions flex justify-end">
        <button type="submit" class="rounded-xl bg-ink px-4 py-2 text-sm font-semibold text-white hover:bg-ocean">
          Save Personal Info
        </button>
      </div>
    </form>
  </section>

  <section class="rounded-3xl border border-ink/10 bg-white p-6 shadow-sm">
    <div class="flex items-center justify-between gap-3">
      <div>
        <h2 class="text-xl font-extrabold">Places I Want to See</h2>
        <p class="mt-1 text-sm text-ink/70">Saved from plan results. Stored independently from any plan.</p>
      </div>
    </div>

    {% if saved_places %}
      <div id="saved-places-grid" class="mt-4 grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
        {% for place in saved_places %}
          <article id="saved-place-{{ place.id }}" class="overflow-hidden rounded-2xl border border-ink/10 bg-white shadow-sm">
            <div class="aspect-[16/9] bg-sky/20">
              <img
                src="{{ place.image_url|default:saved_place_fallback_image }}"
                alt="{{ place.name }}"
                class="h-full w-full object-cover"
                loading="lazy"
                onerror="this.onerror=null;this.src='{{ saved_place_fallback_image }}';"
              >
            </div>
            <div class="p-4">
              <p class="text-sm font-semibold text-ink">{{ place.name }}</p>
              <p class="mt-1 text-xs text-ink/60">
                {% if place.city or place.country %}
                  {{ place.city|default:"" }}{% if place.city and place.country %}, {% endif %}{{ place.country|default:"" }}
                {% else %}
                  Location not specified
                {% endif %}
              </p>
              <p class="mt-1 text-[11px] uppercase tracking-wide text-ink/50">{{ place.source|default:"manual" }}</p>
              {% if place.notes %}
                <p class="mt-2 line-clamp-2 text-xs text-ink/70">{{ place.notes }}</p>
              {% endif %}

              <div class="profile-place-actions mt-3 flex items-center gap-2">
                {% if place.outbound_url %}
                  <a
                    href="{{ place.outbound_url }}"
                    target="_blank"
                    rel="noopener"
                    class="tp-button track-click inline-flex items-center justify-center rounded-lg border border-ink/15 bg-white px-3 py-2 text-xs font-semibold hover:bg-sky/30"
                    data-provider="{{ place.source|default:'manual' }}"
                    data-link-type="place"
                    data-destination="{% if place.city or place.country %}{{ place.city|default:'' }}-{{ place.country|default:'' }}{% endif %}"
                    data-correlation-id="profile:saved-place:{{ place.id }}"
                  >Open</a>
                {% else %}
                  <span class="inline-flex items-center justify-center rounded-lg border border-ink/10 bg-white/60 px-3 py-2 text-xs font-semibold text-ink/50">No link</span>
                {% endif %}
                <button
                  type="button"
                  class="toggle-saved-place rounded-lg border border-rose-200 bg-rose-50 px-3 py-2 text-xs font-semibold text-rose-700 hover:bg-rose-100"
                  data-saved-place-id="{{ place.id }}"
                >Remove</button>
              </div>
            </div>
          </article>
        {% endfor %}
      </div>
    {% else %}
      <div class="mt-4 rounded-2xl border border-dashed border-ink/15 bg-sky/10 p-6 text-sm text-ink/70">
        No saved places yet. Save places from a plan to see them here.
      </div>
    {% endif %}
  </section>
</div>
{% endblock %}

{% block scripts %}
<script>
  (function () {
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return '';
    }
    const csrfToken = getCookie('csrftoken');

    document.body.addEventListener('click', function (event) {
      const tracked = event.target.closest('.track-click');
      if (tracked) {
        fetch('/api/click', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
          body: JSON.stringify({
            provider: tracked.dataset.provider || 'manual',
            link_type: tracked.dataset.linkType || 'place',
            destination: tracked.dataset.destination || '',
            correlation_id: tracked.dataset.correlationId || '',
            outbound_url: tracked.href
          }),
          keepalive: true
        }).catch(() => {});
        return;
      }

      const removeButton = event.target.closest('.toggle-saved-place');
      if (!removeButton) return;
      event.preventDefault();
      removeButton.disabled = true;

      fetch('/api/places/save-toggle', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
        body: JSON.stringify({ saved_place_id: Number(removeButton.dataset.savedPlaceId) })
      })
      .then((response) => response.json().then((payload) => ({ ok: response.ok, payload })))
      .then(({ ok, payload }) => {
        if (!ok) throw new Error((payload && payload.detail) || 'Failed');
        const card = removeButton.closest('article[id^="saved-place-"]');
        if (card) card.remove();
        const countBadge = document.querySelector('section .rounded-full.bg-sky\\/40');
        if (countBadge && typeof payload.saved_places_count === 'number') {
          countBadge.textContent = `${payload.saved_places_count} saved place${payload.saved_places_count === 1 ? '' : 's'}`;
        }
        if (!document.querySelector('#saved-places-grid article')) {
          window.location.reload();
        }
      })
      .catch(() => {
        removeButton.disabled = false;
      });
    });
  })();
</script>
{% endblock %}
